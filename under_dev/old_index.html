<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin UI - DocNest</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background: #f5f5f5;
      }
      h1,
      h2 {
        color: #222;
      }
      form,
      .tree-container {
        background: white;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 6px;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
      }
      input,
      select,
      textarea {
        padding: 0.5rem;
        margin-top: 0.3rem;
        margin-bottom: 1rem;
        width: 100%;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      button {
        background: #007bff;
        color: white;
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .node {
        margin-left: 1.2rem;
        cursor: pointer;
      }
      .plus {
        color: green;
        font-weight: bold;
        cursor: pointer;
        margin-left: 0.5rem;
      }
      .delete {
        color: red;
        font-weight: bold;
        cursor: pointer;
        margin-left: 0.5rem;
      }
      .form-inline {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
        margin-left: 2rem;
      }
      .form-inline input,
      .form-inline select {
        width: 60%;
      }
      .user-actions {
        margin-left: 1rem;
      }
      .user-actions button {
        background: #dc3545;
        margin-left: 0.5rem;
      }
      .user-actions button.update {
        background: #ffc107;
      }
    </style>
  </head>
  <body>
    <h1>üìÇ Admin Panel - DocNest</h1>

    <div class="tree-container">
      <h2>
        üìÅ Folder Structure
        <span class="plus" onclick="promptNewRoot()">[ + ]</span>
      </h2>
      <div id="tree"></div>
    </div>

    <form id="addUserForm">
      <h2>Add User</h2>
      <label>Email</label>
      <input type="email" id="newUserEmail" required />
      <label>Role</label>
      <select id="newUserRole">
        <option value="ADMIN">ADMIN</option>
        <option value="EDITOR">EDITOR</option>
        <option value="VIEWER">VIEWER</option>
      </select>
      <button type="submit">Add User</button>
    </form>

    <div class="tree-container">
      <h2>All Users</h2>
      <ul id="userList"></ul>
    </div>

    <form id="updateAccessForm">
      <h2>Update Access Role</h2>
      <label>Email</label>
      <input type="email" id="updateEmail" required />
      <label>Node ID</label>
      <input type="number" id="updateNodeId" required />
      <label>New Role</label>
      <select id="updateRole">
        <option value="ADMIN">ADMIN</option>
        <option value="EDITOR">EDITOR</option>
        <option value="VIEWER">VIEWER</option>
      </select>
      <button type="submit">Update Role</button>
    </form>

    <form id="revokeAccessForm">
      <h2>Revoke Access</h2>
      <label>Email</label>
      <input type="email" id="revokeEmail" required />
      <label>Node ID</label>
      <input type="number" id="revokeNodeId" required />
      <button type="submit">Revoke Access</button>
    </form>

    <script>
      const BASE = "http://localhost:8000";

      async function fetchTree() {
        const res = await fetch(`${BASE}/api/tree`);
        const data = await res.json();
        document.getElementById("tree").innerHTML = renderTree(data);
      }

      function renderTree(nodes) {
        return nodes
          .map((n) => {
            const children = n.children ? renderTree(n.children) : "";
            const artifacts = n.artifacts
              ? n.artifacts
                  .map(
                    (a) => `
          <div class='node'>
            üßæ ${a.title}
            <span class="delete" onclick="deleteArtifact(${a.id})">[ x ]</span>
          </div>
        `
                  )
                  .join("")
              : "";
            return `
          <div class="node">
            üìÅ ${n.name} (id: ${n.id})
            <span class="plus" onclick="showInlineForm(${n.id})">[ + ]</span>
            <span class="delete" onclick="deleteNode(${n.id})">[ x ]</span>
            <div id="form-${n.id}" class="form-inline" style="display:none">
              <input placeholder="Name" id="name-${n.id}" />
              <select id="type-${n.id}">
                <option value="FOLDER">FOLDER</option>
                <option value="SUBFOLDER">SUBFOLDER</option>
                <option value="FILE">FILE</option>
              </select>
              <input placeholder="Link (if file)" id="link-${n.id}" />
              <button onclick="submitInlineForm(${n.id})">Add</button>
            </div>
            ${children}
            ${artifacts}
          </div>
        `;
          })
          .join("");
      }

      async function fetchNodeName(nodeId) {
        const res = await fetch(`${BASE}/api/nodes/${nodeId}`);
        if (!res.ok) return `Node ${nodeId}`;
        const data = await res.json();
        return `${data.name} (id: ${data.id})`;
      }

      async function fetchUsers() {
        const res = await fetch(`${BASE}/api/users`);
        const users = await res.json();
        const userList = await Promise.all(
          users.map(async (u) => {
            const roles =
              u.roles && u.roles.length > 0
                ? await Promise.all(
                    u.roles.map(async (r) => {
                      const nodeName = await fetchNodeName(r.nodeId);
                      return `${r.role} on ${nodeName}`;
                    })
                  )
                : ["No Role Assigned"];

            return `<li>${u.email} - ${roles.join(", ")}
          <span class="user-actions">
            <button class="update" onclick="prefillUpdate('${u.email}', ${
              u.roles?.[0]?.nodeId || 0
            })">‚úé</button>
            <button onclick="deleteUser('${u.email}')">üóë</button>
          </span>
        </li>`;
          })
        );
        document.getElementById("userList").innerHTML = userList.join("");
      }

      function prefillUpdate(email, nodeId) {
        document.getElementById("updateEmail").value = email;
        document.getElementById("updateNodeId").value = nodeId;
      }

      async function deleteUser(email) {
        if (!confirm(`Delete all access roles for ${email}?`)) return;
        await fetch(`${BASE}/api/users/${email}`, { method: "DELETE" });
        fetchUsers();
      }

      async function submitInlineForm(parentId) {
        const name = document.getElementById(`name-${parentId}`).value;
        const type = document.getElementById(`type-${parentId}`).value;
        const link = document.getElementById(`link-${parentId}`).value;
        if (!name) return alert("Name is required.");

        if (type === "FILE") {
          await fetch(`${BASE}/api/artifacts`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title: name,
              description: "",
              link,
              nodeId: parentId,
            }),
          });
        } else {
          await fetch(`${BASE}/api/nodes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, type, parentId }),
          });
        }

        fetchTree();
      }

      async function deleteNode(nodeId) {
        if (!confirm("Delete this folder and its contents?")) return;
        await fetch(`${BASE}/api/nodes/${nodeId}`, { method: "DELETE" });
        fetchTree();
      }

      async function deleteArtifact(artifactId) {
        if (!confirm("Delete this file?")) return;
        await fetch(`${BASE}/api/artifacts/${artifactId}`, {
          method: "DELETE",
        });
        fetchTree();
      }

      function promptNewRoot() {
        const name = prompt("Enter new vertical name:");
        if (!name) return;
        fetch(`${BASE}/api/nodes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, type: "VERTICAL", parentId: null }),
        }).then(() => fetchTree());
      }

      document
        .getElementById("addUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("newUserEmail").value;
          const role = document.getElementById("newUserRole").value;
          if (!email || !role) return alert("All fields are required.");

          await fetch(`${BASE}/api/users`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, role }),
          });
          alert("User added! ‚úÖ");
          fetchUsers();
        });

      document
        .getElementById("updateAccessForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("updateEmail").value;
          const nodeId = document.getElementById("updateNodeId").value;
          const role = document.getElementById("updateRole").value;

          await fetch(`${BASE}/api/access`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, nodeId: parseInt(nodeId), role }),
          });
          alert("Access updated ‚úÖ");
          fetchUsers();
        });

      document
        .getElementById("revokeAccessForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("revokeEmail").value;
          const nodeId = document.getElementById("revokeNodeId").value;

          await fetch(`${BASE}/api/access`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, nodeId: parseInt(nodeId) }),
          });
          alert("Access revoked ‚úÖ");
          fetchUsers();
        });

      fetchTree();
      fetchUsers();
    </script>
  </body>
</html>
