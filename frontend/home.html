<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Niveus Knowledge Base</title>
    <link rel="stylesheet" href="style.css" />

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script>
      // WARNING: Hardcoding API keys... (Keep your existing warning)
      const firebaseConfig = {
        apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ", // Use environment variables in production
        authDomain: "docnest-f85e2.firebaseapp.com",
        projectId: "docnest-f85e2",
        storageBucket: "docnest-f85e2.appspot.com",
        messagingSenderId: "102395439437",
        appId: "1:102395439437:web:84e6676388b5d54395af04",
        measurementId: "G-YRMBR8BVSE",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      // --- MODIFIED AUTH CHECK ---
      let authInitialized = false; // Flag to track if the listener has run at least once

      auth.onAuthStateChanged((user) => {
        authInitialized = true; // Mark that the check has completed

        if (!user) {
          // User is NOT signed in AFTER the initial check.
          // Redirect to login page, ensuring we are not already there.
          console.log(
            "Auth state checked: No user found. Redirecting to login."
          );
          // Check pathname carefully - adjust if your login page is named differently or has no extension
          if (
            window.location.pathname !== "/login.html" &&
            window.location.pathname !== "/login"
          ) {
            window.location.href = "login.html";
          }
        } else {
          // User IS signed in.
          console.log("Auth state checked: User found.", user.displayName);
          // Good place to hide any loading spinners and show the main content
          document.body.style.display = ""; // Show body content if hidden initially
          // Initialize your application logic here (like loading tables)
        }
      });

      // Optional: Hide body until auth check is complete to prevent flashing
      // Add this CSS or inline style: body { display: none; }
      // Then use document.body.style.display = ''; in the `else` block above.

      // Optional: Timeout fallback (less common now, but can handle edge cases)
      // setTimeout(() => {
      //   if (!authInitialized) {
      //      console.warn("Firebase auth check timed out.");
      //      // Decide fallback behavior - maybe redirect anyway?
      //      if (!auth.currentUser && window.location.pathname !== "/login.html" && window.location.pathname !== "/login") {
      //         console.log("Timeout fallback: No user. Redirecting.");
      //         window.location.href = "login.html";
      //      }
      //   }
      // }, 5000); // e.g., 5 seconds timeout
    </script>
  </head>
  <body>
    <h1>Interactive Knowledge Base</h1>

    <ul class="main-list">
      <li>
        <span class="toggle-item main-item">UDP</span>
        <ul class="sub-list">
          <li data-category="All Niveus">
            <span class="toggle-item sub-item">All Niveus</span>
            <div class="table-container">
              <div class="loading" style="display: none">Loading...</div>
              <table
                data-sheet-url="https://docs.google.com/spreadsheets/d/1ge9cMNSosIZ7xenEguTdcnGwjor6skfqxiaD5qo-vsg/export?format=csv"
              >
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </li>
          <li>
            <span class="toggle-item sub-item">Sub Point 1.2</span>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Header 1.2.X</th>
                    <th>Header 1.2.Y</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Info 1.2.X1</td>
                    <td>Info 1.2.Y1</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </li>
        </ul>
      </li>
      <li>
        <span class="toggle-item main-item">Main Point 2</span>
        <ul class="sub-list">
          <li data-category="Sub Point 2.1">
            <span class="toggle-item sub-item">Sub Point 2.1</span>
            <div class="table-container">
              <div class="loading" style="display: none">Loading...</div>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </li>
        </ul>
      </li>
      <li>
        <span class="toggle-item main-item">Main Point 3</span>
        <ul class="sub-list">
          <li data-category="Sub Point 3.1">
            <span class="toggle-item sub-item">Sub Point 3.1</span>
            <div class="table-container">
              <div class="loading" style="display: none">Loading...</div>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </li>
          <li>
            <span class="toggle-item sub-item">Sub Point 3.2</span>
            <div class="table-container">
              <p>No table for this one, just text content.</p>
            </div>
          </li>
        </ul>
      </li>
    </ul>

    <script src="script.js"></script>
  </body>
</html>
