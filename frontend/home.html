<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Niveus Knowledge Base</title>
    <link rel="stylesheet" href="style.css" />

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ", // Use environment variables
        authDomain: "docnest-f85e2.firebaseapp.com",
        projectId: "docnest-f85e2",
        storageBucket: "docnest-f85e2.appspot.com",
        messagingSenderId: "102395439437",
        appId: "1:102395439437:web:84e6676388b5d54395af04",
        measurementId: "G-YRMBR8BVSE",
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const LOGIN_PAGE_PATH = "login.html"; // The RELATIVE path or filename

      // --- AUTH CHECK ---
      auth.onAuthStateChanged((user) => {
        console.log("Home Page: Auth state change detected.");
        const currentPath = window.location.pathname; // Gets the path part of the URL (e.g., /folder/home.html)
        const currentPage = currentPath.substring(
          currentPath.lastIndexOf("/") + 1
        ); // Gets the filename (e.g., home.html)

        if (!user) {
          // User is NOT signed in AFTER the initial check.
          console.log("Home Page: No user session found.");
          console.log(`Home Page: Current page filename: ${currentPage}`);
          console.log(
            `Home Page: Comparing against login page: ${LOGIN_PAGE_PATH}`
          );

          // Redirect to login only if we are NOT already on the login page.
          // Compare filenames to be more robust against different base paths.
          if (currentPage !== LOGIN_PAGE_PATH) {
            console.log("Home Page: Redirecting to login page...");
            window.location.href = LOGIN_PAGE_PATH; // Use relative path
          } else {
            console.log(
              "Home Page: Already on login page (or filename matches), not redirecting."
            );
            // If somehow this code runs on login.html and user is null, show the body
            document.body.style.display = "";
          }
        } else {
          // User IS signed in.
          console.log("Home Page: User session found:", user.displayName);
          // Show the main content
          document.body.style.display = "";
          // Initialize your application logic here (like loading tables from script.js)
          // Make sure script.js is either loaded defer/async or called from here
          if (typeof initializeTables === "function") {
            // Example check
            // initializeTables(); // Call function from script.js if needed
          }
        }
      });
    </script>
  </head>
  <body>
    <h1>Interactive Knowledge Base</h1>

    <ul class="main-list">
      <li>
        <span class="toggle-item main-item">UDP</span>
        <ul class="sub-list">
          <li data-category="All Niveus">
            <span class="toggle-item sub-item">All Niveus</span>
            <div class="table-container">
              <div class="loading" style="display: none">Loading...</div>
              <table
                data-sheet-url="https://docs.google.com/spreadsheets/d/1ge9cMNSosIZ7xenEguTdcnGwjor6skfqxiaD5qo-vsg/export?format=csv"
              >
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </li>
          <li>
            <span class="toggle-item sub-item">Sub Point 1.2</span>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Header 1.2.X</th>
                    <th>Header 1.2.Y</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Info 1.2.X1</td>
                    <td>Info 1.2.Y1</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </li>
        </ul>
      </li>
      <li>
        <span class="toggle-item main-item">Main Point 2</span>
        <ul class="sub-list">
          <li data-category="Sub Point 2.1">
            <span class="toggle-item sub-item">Sub Point 2.1</span>
            <div class="table-container">
              <div class="loading" style="display: none">Loading...</div>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </li>
        </ul>
      </li>
      <li>
        <span class="toggle-item main-item">Main Point 3</span>
        <ul class="sub-list">
          <li data-category="Sub Point 3.1">
            <span class="toggle-item sub-item">Sub Point 3.1</span>
            <div class="table-container">
              <div class="loading" style="display: none">Loading...</div>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </li>
          <li>
            <span class="toggle-item sub-item">Sub Point 3.2</span>
            <div class="table-container">
              <p>No table for this one, just text content.</p>
            </div>
          </li>
        </ul>
      </li>
    </ul>

    <script src="script.js"></script>
  </body>
</html>
