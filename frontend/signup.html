<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up - DocNest</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gray-900 text-white flex items-center justify-center min-h-screen"
  >
    <div class="bg-gray-800 p-8 rounded shadow-md w-full max-w-md text-center">
      <h1 class="text-2xl font-bold mb-4">Create DocNest Account</h1>
      <p class="mb-4 text-gray-400">Sign up using your Google account</p>

      <div
        id="error-message-signup"
        class="hidden bg-red-200 text-red-800 text-sm p-2 mb-4 rounded"
      ></div>

      <button
        id="signup-button"
        class="bg-white text-black px-6 py-2 rounded hover:bg-gray-200 font-semibold"
      >
        Sign up with Google
      </button>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
      import {
        getDatabase,
        ref,
        get,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

      // ✅ Your Firebase project configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ",
        authDomain: "docnest-f85e2.firebaseapp.com",
        databaseURL:
          "https://docnest-f85e2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "docnest-f85e2",
        storageBucket: "docnest-f85e2.appspot.com",
        messagingSenderId: "102395439437",
        appId: "1:102395439437:web:84e6676388b5d54395af04",
        measurementId: "G-YRMBR8BVSE",
      };

      // ✅ Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      const provider = new GoogleAuthProvider();

      const signupBtn = document.getElementById("signup-button");
      const errorDiv = document.getElementById("error-message-signup");

      function showSignupError(msg) {
        errorDiv.textContent = msg;
        errorDiv.classList.remove("hidden");
      }

      signupBtn.addEventListener("click", async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;

          const inviteToken = new URLSearchParams(window.location.search).get(
            "token"
          );
          if (!inviteToken) {
            showSignupError("Missing invite token.");
            await signOut(auth);
            return;
          }

          const email = user.email;
          const base64Email = btoa(email)
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=+$/, "");
          const inviteRef = ref(db, `invites/${base64Email}`);
          const snapshot = await get(inviteRef);

          if (!snapshot.exists()) {
            showSignupError("No invite found for this email.");
            await signOut(auth);
            return;
          }

          const invite = snapshot.val();

          if (invite.token !== inviteToken) {
            showSignupError("Invite token mismatch.");
            await signOut(auth);
            return;
          }

          if (invite.used) {
            showSignupError("This invite has already been used.");
            await signOut(auth);
            return;
          }

          if (invite.expires_at && new Date() > new Date(invite.expires_at)) {
            showSignupError("This invite has expired.");
            await signOut(auth);
            return;
          }

          // ✅ Delete invite after success
          await remove(inviteRef);

          alert("✅ Signup successful! You may now close this tab.");
          await signOut(auth);
        } catch (err) {
          console.error("Signup error:", err);
          showSignupError("Something went wrong during signup.");
        }
      });
    </script>
  </body>
</html>
