<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin UI - DocNest Admin (Themed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
      :root {
        /* Dark Theme (Default) */
        --bg-primary: #0a0a0a;
        --bg-card: #1a1a1a;
        --bg-card-hover: #222222;
        --bg-input: #2d2d2d;
        --bg-input-readonly: #383838;
        --bg-button-primary: #f0f0f0;
        --bg-button-primary-hover: #ffffff;
        --bg-button-destructive: #c53030;
        --bg-button-destructive-hover: #b02a2a;
        --bg-button-secondary: #4a5568; /* gray-600 like */
        --bg-button-secondary-hover: #2d3748; /* gray-700 like */
        --bg-action-icon-hover: #333;
        --bg-user-list-item: #2c2c2c;
        --bg-user-list-item-hover: #333333;
        --bg-inline-form: rgba(42, 42, 42, 0.85);
        --bg-selected-node: #2a2a2a;
        --bg-modal-overlay: rgba(0, 0, 0, 0.7);
        --bg-modal-content: #1f2937; /* gray-800 like */
        --bg-access-item-even: rgba(255, 255, 255, 0.03);
        --bg-toast-success: #2f5c3b; /* Darker green */
        --bg-toast-error: #5c2f2f; /* Darker red */
        --bg-dropdown-menu: var(--bg-card);

        --text-primary: #e0e0e0;
        --text-secondary: #bbb;
        --text-tertiary: #999;
        --text-placeholder: #888;
        --text-button-primary: #111;
        --text-button-destructive: #ffffff;
        --text-button-secondary: #e2e8f0;
        --text-card-header: #f0f0f0;
        --text-link-hover: #0095ff;
        --text-action-icon: #999;
        --text-action-icon-hover: #ffffff;
        --text-green-accent: #4ade80;
        --text-red-accent: #f87171;
        --text-yellow-accent: #facc15;
        --text-toast: #ffffff;
        --text-dropdown-item-hover: var(--text-link-hover);

        --border-primary: #333;
        --border-input: #555;
        --border-input-focus: #007acc;
        --border-button-primary: #ccc;
        --border-button-primary-hover: #bbb;
        --border-button-destructive: #a02828;
        --border-button-secondary: #4a5568;
        --border-selected-node: #007acc;
        --border-tree-children: rgba(107, 114, 128, 0.3);
        --border-tree-line: #444;
        --border-preview: #555;
        --border-toast-success: #38a169; /* green-600 */
        --border-toast-error: #e53e3e; /* red-600 */
        --border-dropdown-menu: var(--border-primary);

        --shadow-card: 0 8px 20px rgba(0, 0, 0, 0.3);
        --shadow-input-focus: 0 0 0 3px rgba(0, 122, 204, 0.3);
        --shadow-selected-node: inset 2px 0 0 var(--border-selected-node);
        --shadow-modal: 0 10px 25px rgba(0, 0, 0, 0.5);
        --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.4);
        --shadow-dropdown: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);

        --scrollbar-thumb: #4a4a4a;
        --scrollbar-track: #1e1e1e;
      }

      .light-theme {
        --bg-primary: #f4f4f5;
        --bg-card: #ffffff;
        --bg-card-hover: #f9fafb;
        --bg-input: #ffffff;
        --bg-input-readonly: #e5e7eb;
        --bg-button-primary: #27272a;
        --bg-button-primary-hover: #18181b;
        --bg-button-destructive: #ef4444;
        --bg-button-destructive-hover: #dc2626;
        --bg-button-secondary: #e5e7eb;
        --bg-button-secondary-hover: #d1d5db;
        --bg-action-icon-hover: #e5e7eb;
        --bg-user-list-item: #f9fafb;
        --bg-user-list-item-hover: #f3f4f6;
        --bg-inline-form: rgba(243, 244, 246, 0.9);
        --bg-selected-node: #dbeafe;
        --bg-modal-overlay: rgba(0, 0, 0, 0.3);
        --bg-modal-content: #ffffff;
        --bg-access-item-even: #f3f4f6;
        --bg-toast-success: #c6f6d5; /* Lighter green */
        --bg-toast-error: #fed7d7; /* Lighter red */
        --bg-dropdown-menu: var(--bg-card);

        --text-primary: #18181b;
        --text-secondary: #52525b;
        --text-tertiary: #71717a;
        --text-placeholder: #a1a1aa;
        --text-button-primary: #ffffff;
        --text-button-destructive: #ffffff;
        --text-button-secondary: #1f2937;
        --text-card-header: #1f2937;
        --text-link-hover: #2563eb;
        --text-action-icon: #71717a;
        --text-action-icon-hover: #18181b;
        --text-green-accent: #16a34a;
        --text-red-accent: #dc2626;
        --text-yellow-accent: #ca8a04;
        --text-toast: #1a202c; /* Dark text for light toasts */
        --text-dropdown-item-hover: var(--text-link-hover);

        --border-primary: #d1d5db;
        --border-input: #d1d5db;
        --border-input-focus: #2563eb;
        --border-button-primary: #27272a;
        --border-button-primary-hover: #18181b;
        --border-button-destructive: #ef4444;
        --border-button-secondary: #d1d5db;
        --border-selected-node: #2563eb;
        --border-tree-children: rgba(209, 213, 219, 0.5);
        --border-tree-line: #ccc;
        --border-preview: #d1d5db;
        --border-toast-success: #68d391; /* green-400 */
        --border-toast-error: #fc8181; /* red-400 */
        --border-dropdown-menu: var(--border-primary);

        --shadow-card: 0 4px 15px rgba(0, 0, 0, 0.07);
        --shadow-input-focus: 0 0 0 3px rgba(37, 99, 235, 0.2);
        --shadow-selected-node: inset 2px 0 0 var(--border-selected-node);
        --shadow-modal: 0 10px 25px rgba(0, 0, 0, 0.1);
        --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.15);
        --shadow-dropdown: 0 4px 6px -1px rgba(0, 0, 0, 0.07),
          0 2px 4px -1px rgba(0, 0, 0, 0.04);

        --scrollbar-thumb: #a1a1aa;
        --scrollbar-track: #e5e7eb;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .selected-node-highlight {
        background-color: var(--bg-selected-node);
        border-color: var(--border-selected-node);
        border-left-width: 3px;
        box-shadow: var(--shadow-selected-node);
      }
      .form-inline input,
      .form-inline select,
      .form-inline textarea {
        margin-bottom: 0.75rem;
      }
      .node-item:hover .actions,
      .artifact-item:hover .actions {
        opacity: 1;
      }
      .actions {
        transition: opacity 0.2s ease-in-out;
      }
      #tree-container,
      #access-management-modal-current-access,
      #artifact-details-modal-description,
      #userListContainer /* Added for user list scroll */ {
        max-height: 70vh; /* Default max height, can be adjusted */
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
      }
      #tree-container::-webkit-scrollbar,
      #access-management-modal-current-access::-webkit-scrollbar,
      #artifact-details-modal-description::-webkit-scrollbar,
      #userListContainer::-webkit-scrollbar /* Added for user list scroll */ {
        width: 6px;
      }

      #tree-container::-webkit-scrollbar-track,
      #access-management-modal-current-access::-webkit-scrollbar-track,
      #artifact-details-modal-description::-webkit-scrollbar-track,
      #userListContainer::-webkit-scrollbar-track /* Added for user list scroll */ {
        background: var(--scrollbar-track);
      }

      #tree-container::-webkit-scrollbar-thumb,
      #access-management-modal-current-access::-webkit-scrollbar-thumb,
      #artifact-details-modal-description::-webkit-scrollbar-thumb,
      #userListContainer::-webkit-scrollbar-thumb /* Added for user list scroll */ {
        background-color: var(--scrollbar-thumb);
        border-radius: 3px;
      }
      #access-management-modal-current-access {
        max-height: 250px;
      }
      #artifact-details-modal-description {
        max-height: 200px;
      }
      #userListContainer {
        /* Specific height for user list */
        max-height: 400px; /* Adjust as needed */
        min-height: 200px; /* Ensure it has some height even when empty */
        border: 1px solid var(--border-primary);
        border-radius: 0.5rem;
        padding: 0.5rem;
      }

      .submit-button {
        background-color: var(--bg-button-primary);
        color: var(--text-button-primary);
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        border: 1px solid var(--border-button-primary);
        transition: background-color 0.2s ease-in-out,
          transform 0.1s ease-in-out, border-color 0.2s ease-in-out;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .submit-button:hover {
        background-color: var(--bg-button-primary-hover);
        border-color: var(--border-button-primary-hover);
        transform: translateY(-1px);
      }
      .submit-button:active {
        transform: translateY(0px);
      }
      .submit-button.destructive {
        background-color: var(--bg-button-destructive);
        color: var(--text-button-destructive);
        border-color: var(--border-button-destructive);
      }
      .submit-button.destructive:hover {
        background-color: var(--bg-button-destructive-hover);
      }
      .submit-button.secondary {
        background-color: var(--bg-button-secondary);
        color: var(--text-button-secondary);
        border-color: var(--border-button-secondary);
      }
      .submit-button.secondary:hover {
        background-color: var(--bg-button-secondary-hover);
      }
      .submit-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .spinner {
        animation: spin 1s linear infinite;
        border: 2px solid var(--text-button-primary);
        border-top-color: transparent;
        border-radius: 50%;
        width: 1em;
        height: 1em;
        margin-right: 0.5em;
      }
      .light-theme .submit-button .spinner {
        border: 2px solid var(--text-button-primary);
        border-top-color: transparent;
      }
      .submit-button.secondary .spinner,
      .submit-button.destructive .spinner {
        border: 2px solid var(--text-button-secondary);
        border-top-color: transparent;
      }
      .light-theme .submit-button.secondary .spinner {
        border: 2px solid var(--text-button-secondary);
        border-top-color: transparent;
      }

      .input-field,
      textarea.input-field {
        margin-top: 0.25rem;
        display: block;
        width: 100%;
        border-radius: 0.375rem;
        border: 1px solid var(--border-input);
        background-color: var(--bg-input);
        color: var(--text-primary);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out,
          background-color 0.2s ease;
      }
      textarea.input-field {
        min-height: 60px;
      }
      .input-field::placeholder,
      textarea.input-field::placeholder {
        color: var(--text-placeholder);
      }
      .input-field:focus,
      textarea.input-field:focus {
        border-color: var(--border-input-focus);
        outline: none;
        box-shadow: var(--shadow-input-focus);
      }
      .input-field.readonly {
        background-color: var(--bg-input-readonly);
        cursor: not-allowed;
      }

      .label-text {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
      }
      .card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 0.75rem;
        box-shadow: var(--shadow-card);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      .card-header {
        color: var(--text-card-header);
        font-weight: 600;
      }

      /* Tree Styling with Connection Lines */
      .tree-node,
      .tree-artifact-wrapper {
        position: relative;
        padding-left: 20px;
      }
      .tree-node::before,
      .tree-artifact-wrapper::before {
        content: "";
        position: absolute;
        top: 0;
        left: 8px;
        width: 1px;
        height: 100%;
        background-color: var(--border-tree-line);
      }
      .tree-node > .node-content::before,
      .tree-artifact-wrapper > .node-content::before {
        content: "";
        position: absolute;
        top: 12px;
        left: -11px;
        width: 12px;
        height: 1px;
        background-color: var(--border-tree-line);
      }
      .tree-node:last-child::before {
        height: 13px;
      }
      .tree-artifact-wrapper:last-child::before {
        height: 13px;
      }
      .tree-root > .tree-node::before,
      .tree-root > .tree-artifact-wrapper::before {
        display: none;
      }
      .tree-root > .tree-node > .node-content::before,
      .tree-root > .tree-artifact-wrapper > .node-content::before {
        display: none;
      }

      .node-content {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 2px 0;
      }
      .tree-children-container {
        margin-left: 20px;
      }
      .tree-children-container.collapsed {
        display: none;
      }
      .tree-toggle-icon {
        cursor: pointer;
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.25rem;
        color: var(--text-tertiary);
        transition: transform 0.2s ease-in-out;
        display: inline-flex; /* For centering icon */
        align-items: center;
        justify-content: center;
      }
      .tree-toggle-icon.collapsed svg {
        transform: rotate(-90deg);
      }

      .tree-node-text,
      .tree-artifact-text {
        transition: color 0.2s ease-in-out;
        display: flex;
        align-items: center;
      }
      .tree-node-text {
        color: var(--text-primary);
      }
      .tree-artifact-text {
        color: var(--text-tertiary);
      }
      .tree-artifact-text.clickable:hover {
        color: var(--text-link-hover);
        cursor: pointer;
        text-decoration: underline;
      }
      .tree-node-icon {
        color: var(--text-yellow-accent);
      }
      .tree-artifact-icon {
        color: var(--text-tertiary);
      }
      .artifact-preview-container {
        display: none;
      }

      .user-list-item {
        background-color: var(--bg-user-list-item);
        border: 1px solid var(--border-primary);
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out,
          transform 0.2s ease-in-out, border-color 0.2s ease;
      }
      .user-list-item:hover {
        background-color: var(--bg-user-list-item-hover);
        transform: translateY(-2px);
      }
      .user-email-text {
        color: var(--text-primary);
      }
      .user-role-text {
        color: var(--text-secondary);
      }
      .user-node-role-summary {
        color: var(--text-tertiary);
        font-size: 0.8rem;
      }

      .action-icon-btn {
        color: var(--text-action-icon);
        padding: 0.3rem;
        border-radius: 0.25rem;
        transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
      }
      .action-icon-btn:hover {
        color: var(--text-action-icon-hover);
        background-color: var(--bg-action-icon-hover);
      }
      .action-icon-btn.add {
        color: var(--text-green-accent);
      }
      .action-icon-btn.delete {
        color: var(--text-red-accent);
      }
      .action-icon-btn.add:hover {
        color: var(--text-green-accent);
      }
      .action-icon-btn.delete:hover {
        color: var(--text-red-accent);
      }

      .user-action-button {
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8rem;
        font-weight: 500;
        transition: background-color 0.2s ease-in-out,
          transform 0.1s ease-in-out, color 0.2s ease;
        display: inline-flex;
        align-items: center;
      }
      .user-action-button svg {
        margin-right: 0.3rem;
      }
      .user-action-button.manage-access {
        background-color: var(--bg-input);
        color: var(--text-secondary);
        border: 1px solid var(--border-input);
      }
      .user-action-button.manage-access:hover {
        background-color: var(--bg-action-icon-hover);
        color: var(--text-action-icon-hover);
        transform: translateY(-1px);
      }
      .user-action-button.delete-user {
        background-color: var(--bg-button-destructive);
        color: var(--text-button-destructive);
        border: 1px solid var(--border-button-destructive);
      }
      .user-action-button.delete-user:hover {
        background-color: var(--bg-button-destructive-hover);
        transform: translateY(-1px);
      }

      #theme-toggle-button {
        background-color: var(--bg-card);
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
      }
      #theme-toggle-button:hover {
        background-color: var(--bg-card-hover);
        color: var(--text-primary);
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-modal-overlay);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          visibility 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
      }
      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: var(--bg-modal-content);
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: var(--shadow-modal);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.95) translateY(10px);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
      }
      .modal-overlay.active .modal-content {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-card-header);
      }
      .modal-close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-tertiary);
        transition: color 0.2s ease;
      }
      .modal-close-btn:hover {
        color: var(--text-primary);
      }
      .access-item:nth-child(even) {
        background-color: var(--bg-access-item-even);
      }

      /* Search Bar & User Menu */
      #search-tree-input {
        /* For folder/file search */
        width: 100%;
        max-width: 400px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      #search-users-input {
        /* For user search */
        width: 100%;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        margin-bottom: 1rem; /* Space below user search */
      }
      .header-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .user-menu-container {
        position: relative;
      }
      #user-menu-button {
        background-color: var(--bg-card);
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      #user-menu-button:hover {
        background-color: var(--bg-card-hover);
        color: var(--text-primary);
      }
      #user-dropdown-menu {
        background-color: var(--bg-dropdown-menu);
        border: 1px solid var(--border-dropdown-menu);
        box-shadow: var(--shadow-dropdown);
        z-index: 1010;
      }
      #user-dropdown-menu button:hover {
        background-color: var(--bg-card-hover);
        color: var(--text-dropdown-item-hover);
      }

      .hidden-node {
        display: none !important;
      }

      /* Toast Notification Styles */
      #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .toast {
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: var(--text-toast);
        box-shadow: var(--shadow-toast);
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.success {
        background-color: var(--bg-toast-success);
        border: 1px solid var(--border-toast-success);
      }
      .toast.error {
        background-color: var(--bg-toast-error);
        border: 1px solid var(--border-toast-error);
      }
      .toast-icon {
        flex-shrink: 0;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="toast-container"></div>
    <div class="container mx-auto p-4 md:p-8">
      <header
        class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4"
      >
        <div class="flex items-center">
          <img
            src="https://niveussolutions.com/wp-content/uploads/2025/02/Niveus-ntt-data.png"
            alt="DocNest Logo"
            class="h-10 w-auto mr-3"
          />
          <h1
            class="text-4xl sm:text-5xl font-bold tracking-tight text-[var(--text-card-header)]"
          >
            DocNest Admin
          </h1>
        </div>
        <div class="header-controls flex items-center gap-4 ml-auto">
          <input
            type="search"
            id="search-tree-input"
            class="input-field flex-grow max-w-xs sm:max-w-sm md:max-w-md"
            placeholder="Search folders/files..."
          />
          <button
            id="theme-toggle-button"
            class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--border-input-focus)] flex-shrink-0"
            title="Toggle Theme"
          ></button>

          <div class="user-menu-container">
            <button
              id="user-menu-button"
              type="button"
              aria-expanded="false"
              aria-haspopup="true"
            >
              <span id="user-display-name" class="text-sm font-medium"
                >User</span
              >
              <svg
                class="h-5 w-5 text-[var(--text-tertiary)]"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
            <div
              id="user-dropdown-menu"
              class="absolute right-0 mt-2 w-64 origin-top-right rounded-md bg-[var(--bg-dropdown-menu)] shadow-lg ring-1 ring-[var(--border-dropdown-menu)] ring-opacity-5 focus:outline-none hidden"
              role="menu"
              aria-orientation="vertical"
              aria-labelledby="user-menu-button"
            >
              <div class="py-1" role="none">
                <div class="px-4 py-3 border-b border-[var(--border-primary)]">
                  <p
                    class="text-sm font-semibold text-[var(--text-primary)]"
                    id="dropdown-user-name"
                  >
                    User Name
                  </p>
                  <p
                    class="text-xs text-[var(--text-secondary)] truncate"
                    id="dropdown-user-email"
                  >
                    user@example.com
                  </p>
                </div>
                <button
                  id="logout-button-dropdown"
                  class="block w-full px-4 py-2 text-left text-sm text-[var(--text-red-accent)] hover:bg-[var(--bg-card-hover)]"
                  role="menuitem"
                >
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
        <div class="lg:col-span-1 space-y-8">
          <div class="card p-6 rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-5">
              <h2 class="text-2xl card-header">ğŸ“ Folder Structure</h2>
              <button
                onclick="promptNewRoot()"
                class="action-icon-btn add text-2xl"
                title="Add New Root Folder"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 4v16m8-8H4"
                  />
                </svg>
              </button>
            </div>
            <div id="tree-container">
              <div id="tree" class="tree-root space-y-0.5"></div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
          <div class="card p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl card-header mb-6">ğŸ‘¤ Add New User</h2>
            <form id="addUserForm" class="space-y-5">
              <div>
                <label for="newUserEmail" class="label-text">Email Address</label>
                <input
                  type="email"
                  id="newUserEmail"
                  required
                  class="input-field"
                  placeholder="user@example.com"
                />
              </div>
              <div>
                <label for="newUserRole" class="label-text">Assign Global Role</label>
                <select id="newUserRole" class="input-field">
                  <option value="ADMIN">ADMIN</option>
                  <option value="EDITOR">EDITOR</option>
                  <option value="VIEWER">VIEWER</option>
                </select>
              </div>
              <div>
                <label for="newUserNodeAccess" class="label-text">Grant Initial Node Access (Optional)</label>
                <select id="newUserNodeAccess" class="input-field">
                  <option value="">None - Global Role Only</option>
                  </select>
              </div>
        
              <div class="flex items-center mt-1 mb-3"> <input
                  type="checkbox"
                  id="applyGlobalRoleToAllNodesCheckbox"
                  class="h-4 w-4 text-[var(--text-link-hover)] border-[var(--border-input)] rounded focus:ring-[var(--text-link-hover)] mr-2"
                />
                <label for="applyGlobalRoleToAllNodesCheckbox" class="label-text !mb-0 !font-normal text-sm"> Apply global role to all nodes (if 'None' selected above)
                </label>
              </div>
              <div>
                <label for="newUserNodeRole" class="label-text">Role for Selected Node</label>
                <select id="newUserNodeRole" class="input-field">
                  <option value="ADMIN">ADMIN</option>
                  <option value="EDITOR">EDITOR</option>
                  <option value="VIEWER">VIEWER</option>
                </select>
              </div>
              <button type="submit" class="submit-button w-full sm:w-auto">
                <span class="button-text">Add User</span>
              </button>
            </form>
          </div>
        
          </div>

          <div class="card p-6 rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl card-header">ğŸ‘¥ All Users</h2>
            </div>
            <input
              type="search"
              id="search-users-input"
              class="input-field"
              placeholder="Search users by email..."
            />
            <div id="userListContainer">
              <ul id="userList" class="space-y-4"></ul>
              <p
                id="user-list-loading-indicator"
                class="text-center text-[var(--text-secondary)] py-4"
                style="display: none"
              >
                Loading more users...
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="access-management-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">
            Manage Access for
            <span id="modal-user-email" class="font-mono"></span>
          </h3>
          <button class="modal-close-btn" onclick="closeAccessModal()">
            &times;
          </button>
        </div>
        <input type="hidden" id="modal-editing-user-email-hidden" />

        <h4 class="text-lg font-semibold mb-2 text-[var(--text-secondary)]">
          Current Node Access:
        </h4>
        <div
          id="access-management-modal-current-access"
          class="mb-6 space-y-0 border border-[var(--border-primary)] rounded-md"
        >
          <p class="text-[var(--text-tertiary)] p-3">
            No specific node access granted.
          </p>
        </div>

        <h4 class="text-lg font-semibold mb-3 text-[var(--text-secondary)]">
          Grant New Node Access:
        </h4>
        <form
          id="grantNewAccessForm"
          class="space-y-4 p-4 border border-[var(--border-primary)] rounded-md bg-[var(--bg-inline-form)]"
        >
          <div>
            <label for="modalNodeSelect" class="label-text"
              >Select Folder/File</label
            >
            <select id="modalNodeSelect" class="input-field">
              <option value="">-- Select Node --</option>
            </select>
          </div>
          <div>
            <label for="modalNodeRoleSelect" class="label-text"
              >Assign Role</label
            >
            <select id="modalNodeRoleSelect" class="input-field">
              <option value="ADMIN">ADMIN</option>
              <option value="EDITOR">EDITOR</option>
              <option value="VIEWER">VIEWER</option>
            </select>
          </div>
          <button
            type="submit"
            class="submit-button secondary w-full sm:w-auto"
          >
            <span class="button-text">Grant Access</span>
          </button>
        </form>
        <div class="mt-6 text-right">
          <button class="submit-button secondary" onclick="closeAccessModal()">
            <span class="button-text">Close</span>
          </button>
        </div>
      </div>
    </div>

    <div id="artifact-details-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="artifact-modal-title" class="modal-title">
            Artifact Details
          </h3>
          <button class="modal-close-btn" onclick="closeArtifactDetailsModal()">
            &times;
          </button>
        </div>

        <div class="mb-4">
          <label class="label-text">Description:</label>
          <div
            id="artifact-details-modal-description"
            class="p-3 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-sm min-h-[60px]"
          >
            No description provided.
          </div>
        </div>

        <div class="mt-6 text-right space-x-3">
          <a
            id="artifact-modal-link"
            href="#"
            target="_blank"
            class="submit-button inline-block"
          >
            Go to Resource
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 inline-block ml-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              />
            </svg>
          </a>
          <button
            class="submit-button secondary"
            onclick="closeArtifactDetailsModal()"
          >
            <span class="button-text">Close</span>
          </button>
        </div>
      </div>
    </div>

    <div id="delete-confirmation-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="delete-modal-title" class="modal-title">Confirm Deletion</h3>
          <button
            class="modal-close-btn"
            onclick="closeDeleteConfirmationModal()"
          >
            &times;
          </button>
        </div>
        <p id="delete-modal-message" class="mb-4 text-[var(--text-secondary)]">
          Are you sure you want to delete this item? This action cannot be
          undone.
        </p>
        <div class="mb-4">
          <label for="delete-confirm-input" class="label-text"
            >To confirm, type "DELETE" in the box below:</label
          >
          <input
            type="text"
            id="delete-confirm-input"
            class="input-field"
            placeholder="DELETE"
          />
        </div>
        <div class="mt-6 text-right space-x-3">
          <button
            class="submit-button secondary"
            onclick="closeDeleteConfirmationModal()"
          >
            <span class="button-text">Cancel</span>
          </button>
          <button
            id="confirm-delete-button"
            class="submit-button destructive"
            disabled
          >
            <span class="button-text">Delete</span>
          </button>
        </div>
      </div>
    </div>

    <script>
        Â  Â  Â  // --- Firebase Configuration ---
        Â  Â  Â  const firebaseConfig = {
        Â  Â  Â  Â  apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ",
        Â  Â  Â  Â  authDomain: "docnest-f85e2.firebaseapp.com",
        Â  Â  Â  Â  projectId: "docnest-f85e2",
        Â  Â  Â  Â  storageBucket: "docnest-f85e2.appspot.com",
        Â  Â  Â  Â  messagingSenderId: "102395439437",
        Â  Â  Â  Â  appId: "1:102395439437:web:84e6676388b5d54395af04",
        Â  Â  Â  Â  measurementId: "G-YRMBR8BVSE",
        Â  Â  Â  };
        
        Â  Â  Â  // --- Global Helper Functions (defined early) ---
        Â  Â  Â  window.showNotification = function (
        Â  Â  Â  Â  message,
        Â  Â  Â  Â  type = "success",
        Â  Â  Â  Â  duration = 3000
        Â  Â  Â  ) {
        Â  Â  Â  Â  const toastContainer = document.getElementById("toast-container");
        Â  Â  Â  Â  if (!toastContainer) return;
        
        Â  Â  Â  Â  const toast = document.createElement("div");
        Â  Â  Â  Â  toast.classList.add("toast", type);
        
        Â  Â  Â  Â  let iconHtml = "";
        Â  Â  Â  Â  if (type === "success") {
        Â  Â  Â  Â  Â  iconHtml = `<svg class="toast-icon h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        Â  Â  Â  Â  } else if (type === "error") {
        Â  Â  Â  Â  Â  iconHtml = `<svg class="toast-icon h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        Â  Â  Â  Â  } else if (type === "info") { // Added info type for longer messages
                  iconHtml = `<svg class="toast-icon h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                }
        
        
        Â  Â  Â  Â  toast.innerHTML = `${iconHtml}<span>${message}</span>`;
        Â  Â  Â  Â  toastContainer.appendChild(toast);
        
        Â  Â  Â  Â  toast.offsetHeight; // Trigger reflow
        
        Â  Â  Â  Â  toast.classList.add("show");
        
        Â  Â  Â  Â  setTimeout(() => {
        Â  Â  Â  Â  Â  toast.classList.remove("show");
        Â  Â  Â  Â  Â  setTimeout(() => {
        Â  Â  Â  Â  Â  Â  toast.remove();
        Â  Â  Â  Â  Â  }, 300);
        Â  Â  Â  Â  }, duration);
        Â  Â  Â  };
        
        Â  Â  Â  window.setButtonLoading = function (
        Â  Â  Â  Â  button,
        Â  Â  Â  Â  isLoading,
        Â  Â  Â  Â  originalText = null
        Â  Â  Â  ) {
        Â  Â  Â  Â  if (!(button instanceof HTMLElement)) {
        Â  Â  Â  Â  Â  console.error("setButtonLoading: button argument is not an HTMLElement", button);
        Â  Â  Â  Â  Â  return;
        Â  Â  Â  Â  }
        Â  Â  Â  Â  const buttonTextSpan = button.querySelector(".button-text");
        Â  Â  Â  Â  if (isLoading) {
        Â  Â  Â  Â  Â  button.disabled = true;
        Â  Â  Â  Â  Â  if (buttonTextSpan) {
        Â  Â  Â  Â  Â  Â  if (originalText !== null && typeof buttonTextSpan.dataset.originalText === 'undefined') { // Store original text only once
                         buttonTextSpan.dataset.originalText = buttonTextSpan.innerHTML;
                    }
        Â  Â  Â  Â  Â  Â  buttonTextSpan.innerHTML = `<span class="spinner"></span>Processing...`;
        Â  Â  Â  Â  Â  } else {
                    if (originalText !== null && typeof button.dataset.originalText === 'undefined') {
                         button.dataset.originalText = button.innerHTML;
                    }
        Â  Â  Â  Â  Â  Â  button.innerHTML = `<span class="spinner"></span>Processing...`;
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  button.disabled = false;
        Â  Â  Â  Â  Â  if (buttonTextSpan) {
        Â  Â  Â  Â  Â  Â  buttonTextSpan.innerHTML = buttonTextSpan.dataset.originalText || originalText || "Submit";
                    delete buttonTextSpan.dataset.originalText; // Clean up
        Â  Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  Â  button.innerHTML = button.dataset.originalText || originalText || "Submit";
                    delete button.dataset.originalText; // Clean up
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  }
        Â  Â  Â  };
        Â  Â  Â  // --- End Global Helper Functions ---
        
        Â  Â  Â  // Initialize Firebase (compat version)
        Â  Â  Â  let firebaseApp;
        Â  Â  Â  let firebaseAuth;
        
        Â  Â  Â  try {
        Â  Â  Â  Â  firebaseApp = firebase.initializeApp(firebaseConfig);
        Â  Â  Â  Â  firebaseAuth = firebase.auth();
        Â  Â  Â  Â  console.log("Firebase initialized successfully.");
        Â  Â  Â  } catch (e) {
        Â  Â  Â  Â  console.error("Error initializing Firebase:", e);
        Â  Â  Â  Â  window.showNotification("Critical Error: Could not initialize Firebase. Check console.", "error", 10000);
        Â  Â  Â  }
        
        Â  Â  Â  // --- Auth State Management ---
        Â  Â  Â  const userMenuButton = document.getElementById("user-menu-button");
        Â  Â  Â  const userDisplayNameSpan = document.getElementById("user-display-name");
        Â  Â  Â  const userDropdownMenu = document.getElementById("user-dropdown-menu");
        Â  Â  Â  const dropdownUserName = document.getElementById("dropdown-user-name");
        Â  Â  Â  const dropdownUserEmail = document.getElementById("dropdown-user-email");
        Â  Â  Â  const logoutButtonDropdown = document.getElementById("logout-button-dropdown");
        
        Â  Â  Â  if (firebaseAuth) {
        Â  Â  Â  Â  firebaseAuth.onAuthStateChanged((user) => {
        Â  Â  Â  Â  Â  if (user) {
        Â  Â  Â  Â  Â  Â  console.log("âœ… Admin Panel: Logged in as", user.email);
        Â  Â  Â  Â  Â  Â  if (userDisplayNameSpan) userDisplayNameSpan.textContent = user.displayName || user.email.split("@")[0];
        Â  Â  Â  Â  Â  Â  if (dropdownUserName) dropdownUserName.textContent = user.displayName || "N/A";
        Â  Â  Â  Â  Â  Â  if (dropdownUserEmail) dropdownUserEmail.textContent = user.email;
        Â  Â  Â  Â  Â  Â  initializeAdminPanel();
        Â  Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  Â  console.log("ğŸš« Admin Panel: No user logged in. Redirecting...");
        Â  Â  Â  Â  Â  Â  sessionStorage.removeItem("token");
        Â  Â  Â  Â  Â  Â  if (!window.location.pathname.endsWith("login_admin.html")) {
        Â  Â  Â  Â  Â  Â  Â  window.location.href = "login_admin.html";
        Â  Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  });
        Â  Â  Â  } else {
        Â  Â  Â  Â  console.error("Firebase Auth is not available. Admin panel features requiring authentication will not work.");
                if (document.body && !window.location.pathname.endsWith("login_admin.html")) { // Ensure body exists for notification
                   window.showNotification("Authentication service unavailable. Please check console.", "error",10000);
                }
        Â  Â  Â  }
        
        Â  Â  Â  async function getAuthToken() {
        Â  Â  Â  Â  if (!firebaseAuth || !firebaseAuth.currentUser) {
        Â  Â  Â  Â  Â  console.warn("No current user for getAuthToken.");
        Â  Â  Â  Â  Â  if (firebaseAuth) window.showNotification("Session expired or not logged in.", "error");
        Â  Â  Â  Â  Â  return null;
        Â  Â  Â  Â  }
        Â  Â  Â  Â  try {
        Â  Â  Â  Â  Â  const token = await firebaseAuth.currentUser.getIdToken(true);
        Â  Â  Â  Â  Â  sessionStorage.setItem("token", token);
        Â  Â  Â  Â  Â  return token;
        Â  Â  Â  Â  } catch (error) {
        Â  Â  Â  Â  Â  console.error("Error getting ID token:", error);
        Â  Â  Â  Â  Â  window.showNotification("Could not refresh auth token. Please log in again.", "error");
        Â  Â  Â  Â  Â  if (error.code === "auth/user-token-expired" || error.code === "auth/invalid-user-token") {
        Â  Â  Â  Â  Â  Â  // if (!window.location.pathname.endsWith("login_admin.html")) {
        Â  Â  Â  Â  Â  Â  // window.location.href = "login_admin.html";
        Â  Â  Â  Â  Â  Â  // }
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  return null;
        Â  Â  Â  Â  }
        Â  Â  Â  }
        
        Â  Â  Â  async function secureFetch(url, options = {}) {
        Â  Â  Â  Â  const token = await getAuthToken();
        Â  Â  Â  Â  if (!token && url !== `${BASE}/api/tree`) { // Tree might be public, other calls need token
        Â  Â  Â  Â  Â  console.error("Auth token not available for secureFetch to " + url);
        Â  Â  Â  Â  Â  throw new Error("Authentication token not available. Please log in.");
        Â  Â  Â  Â  }
        Â  Â  Â  Â  const headers = { ...options.headers };
        Â  Â  Â  Â  if (token) headers["Authorization"] = `Bearer ${token}`;
        Â  Â  Â  Â  if (!(options.body instanceof FormData)) headers["Content-Type"] = "application/json";
        
        Â  Â  Â  Â  try {
        Â  Â  Â  Â  Â  const response = await fetch(url, { ...options, headers });
        Â  Â  Â  Â  Â  return response;
        Â  Â  Â  Â  } catch (networkError) {
        Â  Â  Â  Â  Â  console.error("Network error during secureFetch:", networkError);
        Â  Â  Â  Â  Â  window.showNotification("Network error. Check connection.", "error");
        Â  Â  Â  Â  Â  throw networkError;
        Â  Â  Â  Â  }
        Â  Â  Â  }
        
        Â  Â  Â  const BASE = "http://localhost:8000";
        Â  Â  Â  let fullTreeData = [];
        Â  Â  Â  let flatNodeList = []; // Used for dropdowns and new feature
        
        Â  Â  Â  // --- Theme Toggle (existing code) ---
        Â  Â  Â  const themeToggleButton = document.getElementById("theme-toggle-button");
        Â  Â  Â  const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
        Â  Â  Â  const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
        Â  Â  Â  function applyTheme(theme) { /* ... (no changes to this function) ... */
                if (theme === "light") {
        Â  Â  Â  Â  Â  document.body.classList.add("light-theme");
        Â  Â  Â  Â  Â  themeToggleButton.innerHTML = moonIcon;
        Â  Â  Â  Â  Â  localStorage.setItem("theme", "light");
        Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  document.body.classList.remove("light-theme");
        Â  Â  Â  Â  Â  themeToggleButton.innerHTML = sunIcon;
        Â  Â  Â  Â  Â  localStorage.setItem("theme", "dark");
        Â  Â  Â  Â  }
              }
        Â  Â  Â  themeToggleButton.addEventListener("click", () => applyTheme(document.body.classList.contains("light-theme") ? "dark" : "light"));
        Â  Â  Â  applyTheme(localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "dark"));
        
              function escapeJSString(str) { /* ... (no changes to this function) ... */
                if (typeof str !== "string") return "";
        Â  Â  Â  Â  return str.replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/`/g, "\\`");
              }
        
        Â  Â  Â  // --- Tree Search (existing code) ---
        Â  Â  Â  const searchTreeInput = document.getElementById("search-tree-input");
        Â  Â  Â  searchTreeInput.addEventListener("input", (e) => filterTreeDOM(e.target.value.toLowerCase()));
        Â  Â  Â  function filterTreeDOM(searchTerm) { /* ... (no changes to this function) ... */
                const treeElement = document.getElementById("tree");
        Â  Â  Â  Â  if (!treeElement) return;
        
        Â  Â  Â  Â  function checkVisibility(element, term) {
        Â  Â  Â  Â  Â  let directMatch = false;
        Â  Â  Â  Â  Â  const nodeName = (element.dataset.nodeName || "").toLowerCase();
        Â  Â  Â  Â  Â  if (nodeName.includes(term)) {
        Â  Â  Â  Â  Â  Â  directMatch = true;
        Â  Â  Â  Â  Â  }
        
        Â  Â  Â  Â  Â  let childrenMatch = false;
        Â  Â  Â  Â  Â  if (element.classList.contains("tree-node")) {
        Â  Â  Â  Â  Â  Â  const childrenContainer = element.querySelector(".tree-children-container");
        Â  Â  Â  Â  Â  Â  if (childrenContainer) {
        Â  Â  Â  Â  Â  Â  Â  const childrenElements = childrenContainer.children;
        Â  Â  Â  Â  Â  Â  Â  for (const child of childrenElements) {
        Â  Â  Â  Â  Â  Â  Â  Â  if (checkVisibility(child, term)) {
        Â  Â  Â  Â  Â  Â  Â  Â  Â  childrenMatch = true;
                          break; // Found a match in children, no need to check further for this parent
        Â  Â  Â  Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  }
        
        Â  Â  Â  Â  Â  const shouldBeVisible = directMatch || childrenMatch;
        Â  Â  Â  Â  Â  element.classList.toggle("hidden-node", !shouldBeVisible && term.length > 0);
                  
                  // Expand parent if a child matches and parent itself doesn't
                  if (shouldBeVisible && childrenMatch && element.classList.contains("tree-node")) {
                    const childrenContainer = document.getElementById(`children-${element.dataset.nodeId}`);
                    const toggleIcon = document.getElementById(`toggle-icon-${element.dataset.nodeId}`);
                    if (childrenContainer && childrenContainer.classList.contains("collapsed") && term.length > 0) {
                        toggleTreeNode(element.dataset.nodeId, false); // Expand, don't toggle
                    }
                  }
        Â  Â  Â  Â  Â  return shouldBeVisible;
        Â  Â  Â  Â  }
        
        Â  Â  Â  Â  if (searchTerm.length === 0) {
        Â  Â  Â  Â  Â  treeElement.querySelectorAll(".hidden-node").forEach((el) => el.classList.remove("hidden-node"));
        Â  Â  Â  Â  Â  return;
        Â  Â  Â  Â  }
        
        Â  Â  Â  Â  const topLevelNodes = Array.from(treeElement.children);
        Â  Â  Â  Â  topLevelNodes.forEach(node => checkVisibility(node, searchTerm));
              }
        
        Â  Â  Â  // --- Tree and Node Dropdown Population (existing code) ---
        Â  Â  Â  function generateFlatNodeList(nodes, prefix = "", level = 0) { /* ... (no changes) ... */
                let list = [];
        Â  Â  Â  Â  nodes.forEach((node) => {
        Â  Â  Â  Â  Â  list.push({ id: node.id, name: `${"â€”".repeat(level)} ${node.name} (Folder)`, type: "NODE" });
        Â  Â  Â  Â  Â  if (node.artifacts) {
        Â  Â  Â  Â  Â  Â  node.artifacts.forEach((artifact) => {
        Â  Â  Â  Â  Â  Â  Â  list.push({ id: artifact.id, name: `${"â€”".repeat(level + 1)} ${artifact.title} (File)`, type: "ARTIFACT", nodeId: artifact.id });
        Â  Â  Â  Â  Â  Â  });
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  if (node.children) {
        Â  Â  Â  Â  Â  Â  list = list.concat(generateFlatNodeList(node.children, prefix + "â€”", level + 1));
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  });
        Â  Â  Â  Â  return list;
              }
        Â  Â  Â  function populateNodeDropdowns() { /* ... (no changes) ... */
                flatNodeList = generateFlatNodeList(fullTreeData);
        Â  Â  Â  Â  const newUserNodeSelect = document.getElementById("newUserNodeAccess");
        Â  Â  Â  Â  const modalNodeSelect = document.getElementById("modalNodeSelect");
        Â  Â  Â  Â  if (!newUserNodeSelect || !modalNodeSelect) return;
        Â  Â  Â  Â  newUserNodeSelect.length = 1; // Keep "None" option
        Â  Â  Â  Â  modalNodeSelect.length = 1;   // Keep "-- Select Node --" option
        Â  Â  Â  Â  flatNodeList.forEach((item) => {
        Â  Â  Â  Â  Â  const option = new Option(item.name, item.id);
        Â  Â  Â  Â  Â  newUserNodeSelect.add(option.cloneNode(true));
        Â  Â  Â  Â  Â  modalNodeSelect.add(option);
        Â  Â  Â  Â  });
              }
        Â  Â  Â  async function fetchTree() { /* ... (no changes) ... */
                try {
        Â  Â  Â  Â  Â  const res = await secureFetch(`${BASE}/api/tree`);
        Â  Â  Â  Â  Â  if (!res.ok) { /* ... error handling ... */ throw new Error(`HTTP error! status: ${res.status}`);}
        Â  Â  Â  Â  Â  fullTreeData = await res.json();
        Â  Â  Â  Â  Â  document.getElementById("tree").innerHTML = renderTree(fullTreeData);
        Â  Â  Â  Â  Â  populateNodeDropdowns();
        Â  Â  Â  Â  } catch (error) { /* ... error handling ... */ 
                    console.error("Failed to fetch tree:", error);
                    window.showNotification(`Error loading folder structure: ${error.message}`, "error");
                    document.getElementById("tree").innerHTML = `<p class="text-[var(--text-red-accent)] p-4">Error loading folder structure.</p>`;
                }
              }
              function toggleTreeNode(nodeId, doToggle = true) { // Added doToggle parameter
                const childrenContainer = document.getElementById(`children-${nodeId}`);
                const toggleIcon = document.getElementById(`toggle-icon-${nodeId}`);
                if (childrenContainer && toggleIcon) {
                    let isCollapsed;
                    if (doToggle) {
                        isCollapsed = childrenContainer.classList.toggle("collapsed");
                    } else {
                        childrenContainer.classList.remove("collapsed"); // Ensure expanded
                        isCollapsed = false;
                    }
                    toggleIcon.classList.toggle("collapsed", isCollapsed);
                    toggleIcon.innerHTML = isCollapsed
                        ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>`
                        : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>`;
                }
            }
        Â  Â  Â  function renderTree(nodes) { /* ... (no changes to this function, assuming it's correct) ... */
                if (!Array.isArray(nodes)) { return '<p class="text-[var(--text-red-accent)] p-2">Invalid tree data.</p>';}
        Â  Â  Â  Â  return nodes.map((n) => {
        Â  Â  Â  Â  Â  Â  const hasChildrenOrArtifacts = (n.children && n.children.length > 0) || (n.artifacts && n.artifacts.length > 0);
        Â  Â  Â  Â  Â  Â  const childrenHTML = n.children ? renderTree(n.children) : "";
        Â  Â  Â  Â  Â  Â  const nodeNameSafe = escapeJSString(n.name);
        Â  Â  Â  Â  Â  Â  const artifactsHTML = n.artifacts ? n.artifacts.map(a => {
                      const titleContent = escapeJSString(a.title);
                      const descriptionContent = escapeJSString(a.description || "");
                      const linkContent = escapeJSString(a.link || "#");
                      return `
                        <div class="tree-artifact-wrapper" data-artifact-id="${a.id}" data-node-id="${a.id}" data-node-name="${titleContent}" data-node-type="ARTIFACT" data-parent-node-id="${n.id}">
                            <div class="node-content group hover:bg-[var(--bg-card-hover)] rounded-md px-1 py-0.5">
                                <span class="tree-artifact-text clickable flex items-center text-sm flex-grow" title="View details for: ${titleContent}" onclick="showArtifactDetailsModal('${titleContent}', '${descriptionContent}', '${linkContent}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 tree-artifact-icon flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                                    <span>${titleContent}</span>
                                </span>
                                <div class="actions opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button title="Delete file" class="action-icon-btn delete" onclick="event.stopPropagation(); openDeleteConfirmationModal(${a.id}, 'artifact', '${titleContent}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                </div>
                            </div>
                        </div>`;
                    }).join("") : "";
        Â  Â  Â  Â  Â  Â  return `
                        <div class="tree-node" data-node-id="${n.id}" data-node-name="${nodeNameSafe}" data-node-type="NODE">
                            <div class="node-content group hover:bg-[var(--bg-card-hover)] rounded-md px-1 py-0.5">
                                <span class="font-medium tree-node-text cursor-pointer flex items-center flex-grow" onclick="toggleTreeNode(${n.id})">
                                    ${hasChildrenOrArtifacts ? `<span id="toggle-icon-${n.id}" class="tree-toggle-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg></span>` : '<span class="tree-toggle-icon w-5 h-5 mr-1"></span>'}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 tree-node-icon flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                                    <span>${nodeNameSafe}</span> <span class="text-xs text-[var(--text-tertiary)] ml-1.5">(ID: ${n.id})</span>
                                </span>
                                <div class="actions opacity-0 group-hover:opacity-100 transition-opacity space-x-1">
                                    <button title="Add item to this folder" class="action-icon-btn add" onclick="event.stopPropagation(); showInlineForm(${n.id}, this)"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                                    <button title="Delete folder" class="action-icon-btn delete" onclick="event.stopPropagation(); openDeleteConfirmationModal(${n.id}, 'node', '${nodeNameSafe}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                </div>
                            </div>
                            <div id="form-${n.id}" class="form-inline mt-2 ml-5 p-4 bg-[var(--bg-inline-form)] rounded-lg border border-[var(--border-primary)] shadow-md" style="display:none;">
                                <input type="text" placeholder="Name (Folder/File)" id="name-${n.id}" class="input-field text-sm">
                                <select id="type-${n.id}" class="input-field text-sm" onchange="toggleFileInput(${n.id})"><option value="FOLDER">FOLDER</option><option value="SUBFOLDER">SUBFOLDER</option><option value="FILE">FILE</option></select>
                                <textarea placeholder="Description (Optional)" id="description-${n.id}" class="input-field text-sm" rows="2"></textarea>
                                <div id="file-method-options-${n.id}" style="display:none;">
                                    <div class="mb-2"><label class="label-text text-xs">File Source:</label><select id="file-source-${n.id}" class="input-field text-xs py-1" onchange="toggleLinkOrUpload(${n.id})"><option value="link">Enter Link</option><option value="upload">Upload File</option></select></div>
                                    <div id="link-input-container-${n.id}"><input type="text" placeholder="Link (e.g., https://...)" id="link-${n.id}" class="input-field text-sm"></div>
                                    <div id="upload-input-container-${n.id}" style="display:none;"><input type="file" id="file-upload-${n.id}" class="input-field text-sm p-2"></div>
                                </div>
                                <button onclick="submitInlineForm(${n.id}, this)" class="submit-button text-sm w-full py-2"><span class="button-text">Add Item</span></button>
                            </div>
                            <div class="tree-children-container collapsed" id="children-${n.id}">${childrenHTML}${artifactsHTML}</div>
                        </div>`;
        Â  Â  Â  Â  }).join("");
        Â  Â  Â  }
              async function fetchNodeName(nodeId) { /* ... (no changes to this function) ... */
                if (!nodeId || String(nodeId).toLowerCase() === "null" || typeof nodeId === "undefined") { return "Global / Unspecified Node"; }
                const localNode = flatNodeList.find((n) => String(n.id) === String(nodeId));
                if (localNode) { return `${localNode.name.replace(/â€”/g, "").trim()} (ID: ${nodeId})`;}
                try {
                    let res = await secureFetch(`${BASE}/api/nodes/${nodeId}`);
                    if (res.ok) { const data = await res.json(); return data.name ? `${data.name} (Folder) (ID: ${data.id})` : `Item ${nodeId}`; }
                    res = await secureFetch(`${BASE}/api/artifacts/${nodeId}`);
                    if (res.ok) { const data = await res.json(); return data.title ? `${data.title} (File) (ID: ${data.id})` : `Item ${nodeId}`; }
                    console.warn(`Node/Artifact fetch failed for ID ${nodeId} (status: ${res.status}).`); return `Item ${nodeId}`;
                } catch (error) { console.error(`Error fetching details for ID ${nodeId}:`, error); window.showNotification(`Error: ${error.message}`, "error"); return `Item ${nodeId}`; }
              }
        
        Â  Â  Â  // --- User Management (existing code with modifications) ---
        Â  Â  Â  let allUsersMasterList = [];
        Â  Â  Â  let currentUsersToDisplay = [];
        Â  Â  Â  let displayedUserCount = 0;
        Â  Â  Â  const usersPerPage = 10;
        Â  Â  Â  let isLoadingUsers = false; // Global lock for fetchUsers operation and pagination
        Â  Â  Â  const userSearchInput = document.getElementById("search-users-input");
        Â  Â  Â  const userListContainer = document.getElementById("userListContainer");
        Â  Â  Â  const userListElement = document.getElementById("userList");
        Â  Â  Â  const userListLoadingIndicator = document.getElementById("user-list-loading-indicator");
        
        Â  Â  Â  async function fetchUsers() {
        Â  Â  Â  Â  if (isLoadingUsers) return;
        Â  Â  Â  Â  isLoadingUsers = true;
        Â  Â  Â  Â  userListLoadingIndicator.style.display = "block"; // Show "Loading more users..."
        
        Â  Â  Â  Â  try {
        Â  Â  Â  Â  Â  const res = await secureFetch(`${BASE}/api/users`);
        Â  Â  Â  Â  Â  if (!res.ok) {
        Â  Â  Â  Â  Â  Â  let errorMsg = `HTTP error! status: ${res.status}`;
        Â  Â  Â  Â  Â  Â  try { const errData = await res.json(); errorMsg += ` - ${errData.message || errData.error || JSON.stringify(errData)}`; } catch (e) { /* ignore */ }
        Â  Â  Â  Â  Â  Â  throw new Error(errorMsg);
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  const users = await res.json();
        Â  Â  Â  Â  Â  allUsersMasterList = users.reverse();
        Â  Â  Â  Â  Â  applyUserSearchFilter();
        Â  Â  Â  Â  } catch (error) {
        Â  Â  Â  Â  Â  console.error("Failed to fetch users:", error);
        Â  Â  Â  Â  Â  window.showNotification(`Error loading users: ${error.message}`, "error");
        Â  Â  Â  Â  Â  userListElement.innerHTML = `<p class="text-[var(--text-red-accent)] p-2">Failed to load users.</p>`;
        Â  Â  Â  Â  } finally {
        Â  Â  Â  Â  Â  isLoadingUsers = false;
        Â  Â  Â  Â  Â  userListLoadingIndicator.style.display = "none"; // Hide "Loading more users..."
        Â  Â  Â  Â  }
        Â  Â  Â  }
        
        Â  Â  Â  function applyUserSearchFilter() {
        Â  Â  Â  Â  const searchTerm = userSearchInput.value.toLowerCase().trim();
        Â  Â  Â  Â  currentUsersToDisplay = searchTerm === "" ? [...allUsersMasterList] : allUsersMasterList.filter(user => user.email.toLowerCase().includes(searchTerm));
        Â  Â  Â  Â  userListElement.innerHTML = "";
        Â  Â  Â  Â  displayedUserCount = 0;
        Â  Â  Â  Â  renderPaginatedUsers(); // Call with loadMore = false
        Â  Â  Â  }
        
        Â  Â  Â  userSearchInput.addEventListener("input", applyUserSearchFilter);
        
        Â  Â  Â  async function renderPaginatedUsers(loadMore = false) {
                // FIX for initial users not showing: Removed the problematic first condition
                // Original: if (isLoadingUsers && !loadMore) return;
        
                // This condition prevents multiple scroll-triggered loads if a fetch is active OR another scroll-load is already setting isLoadingUsers
                if (isLoadingUsers && loadMore) {
                    console.log("RenderPaginatedUsers: A user list operation is already in progress, or main fetch active.");
                    return;
                }
        
                const isCurrentlyPaginatingOperation = loadMore; // True if this specific call is for pagination
        
                if (isCurrentlyPaginatingOperation) {
                    isLoadingUsers = true; // Use global lock to signify this pagination operation is active
                    userListLoadingIndicator.style.display = "block";
                }
                // For !loadMore (initial/filter), isLoadingUsers is managed by fetchUsers or is false for search.
        
        Â  Â  Â  Â  const usersToRender = currentUsersToDisplay.slice(displayedUserCount, displayedUserCount + usersPerPage);
        
        Â  Â  Â  Â  if (usersToRender.length === 0) {
        Â  Â  Â  Â  Â  if (displayedUserCount === 0) {
        Â  Â  Â  Â  Â  Â  userListElement.innerHTML = `<p class="text-[var(--text-tertiary)] p-3 text-center">No users found matching your criteria.</p>`;
        Â  Â  Â  Â  Â  }
                  if (isCurrentlyPaginatingOperation) {
        Â  Â  Â  Â  Â      isLoadingUsers = false; // Release lock if it was set for pagination
        Â  Â  Â  Â  Â      userListLoadingIndicator.style.display = "none";
                  }
        Â  Â  Â  Â  Â  return;
        Â  Â  Â  Â  }
        
        Â  Â  Â  Â  const userListPromises = usersToRender.map(async (u) => {
        Â  Â  Â  Â  Â  let nodeAccessSummary = "No specific node roles.";
        Â  Â  Â  Â  Â  if (u.roles && u.roles.length > 0) {
        Â  Â  Â  Â  Â  Â  nodeAccessSummary = `Node Access: ${u.roles.length} role${u.roles.length > 1 ? "s" : ""}`;
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  return `
        Â  Â  Â  Â  Â  Â  <li class="user-list-item p-4 rounded-lg shadow-md flex flex-col sm:flex-row justify-between sm:items-center space-y-3 sm:space-y-0">
        Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow">
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-semibold user-email-text block text-md">${escapeJSString(u.email)}</span>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm user-role-text block">${u.role ? `Global: ${u.role}` : "No Global Role"}</span>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="user-node-role-summary block mt-1">${nodeAccessSummary}</span>
        Â  Â  Â  Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-actions space-x-2 flex-shrink-0 mt-3 sm:mt-0">
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="user-action-button manage-access" title="Manage User Access" onclick="openAccessModal('${escapeJSString(u.email)}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                Manage Access
                            </button>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="user-action-button delete-user" title="Delete User & All Access" onclick="deleteUser('${escapeJSString(u.email)}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                Delete User
                            </button>
        Â  Â  Â  Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  Â  </li>`;
        Â  Â  Â  Â  });
        Â  Â  Â  Â  const userListHtmlChunk = await Promise.all(userListPromises);
        Â  Â  Â  Â  userListElement.insertAdjacentHTML("beforeend", userListHtmlChunk.join(""));
        Â  Â  Â  Â  displayedUserCount += usersToRender.length;
        
                if (isCurrentlyPaginatingOperation) {
        Â  Â  Â  Â      isLoadingUsers = false; // Release lock if it was set for pagination
        Â  Â  Â  Â      userListLoadingIndicator.style.display = "none";
                }
        Â  Â  Â  }
        
        
        Â  Â  Â  userListContainer.addEventListener("scroll", () => {
                // The isLoadingUsers check here prevents starting a new pagination
                // if a main fetch (fetchUsers) is running OR if a previous pagination
                // (which also uses isLoadingUsers as its lock in the modified renderPaginatedUsers) is running.
        Â  Â  Â  Â  if (isLoadingUsers) return;
        
        Â  Â  Â  Â  const { scrollTop, scrollHeight, clientHeight } = userListContainer;
        Â  Â  Â  Â  if (scrollTop + clientHeight >= scrollHeight - 100) {
        Â  Â  Â  Â  Â  if (displayedUserCount < currentUsersToDisplay.length) {
        Â  Â  Â  Â  Â  Â  renderPaginatedUsers(true);
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  }
        Â  Â  Â  });
        
        Â  Â  Â  async function deleteUser(email) { /* ... (no changes to this function) ... */
                if (!confirm(`Are you sure you want to delete all access roles and user data for ${email}? This action cannot be undone.`)) return;
                try {
                    const response = await secureFetch(`${BASE}/api/users/${email}`, { method: "DELETE" });
                    if (!response.ok) { const errorData = await response.json().catch(() => ({ message: response.statusText })); throw new Error(`HTTP error! status: ${errorData.message || response.statusText}`); }
                    window.showNotification("User deleted successfully. âœ…", "success");
                    fetchUsers(); 
                } catch (error) { console.error("Failed to delete user:", error); window.showNotification(`Error deleting user: ${error.message}`, "error");}
              }
        Â  Â  Â  function showInlineForm(parentId, buttonElement) { /* ... (no changes) ... */
                const form = document.getElementById(`form-${parentId}`);
                if (form) {
                    const isVisible = form.style.display === "block";
                    form.style.display = isVisible ? "none" : "block";
                    if (!isVisible) { form.querySelector('input[type="text"], select')?.focus(); toggleFileInput(parentId); }
                }
              }
        Â  Â  Â  function toggleFileInput(parentId) { /* ... (no changes) ... */
                const typeSelect = document.getElementById(`type-${parentId}`);
                const fileMethodOptionsDiv = document.getElementById(`file-method-options-${parentId}`);
                const descriptionTextarea = document.getElementById(`description-${parentId}`);
                if (typeSelect.value === "FILE") {
                    fileMethodOptionsDiv.style.display = "block";
                    descriptionTextarea.placeholder = "Description (Optional for File)";
                    document.getElementById(`file-source-${parentId}`).value = "link";
                    toggleLinkOrUpload(parentId);
                } else {
                    fileMethodOptionsDiv.style.display = "none";
                    descriptionTextarea.placeholder = "Description (Optional for Folder)";
                }
              }
        Â  Â  Â  function toggleLinkOrUpload(parentId) { /* ... (no changes) ... */
                const fileSource = document.getElementById(`file-source-${parentId}`).value;
                const linkInputContainer = document.getElementById(`link-input-container-${parentId}`);
                const uploadInputContainer = document.getElementById(`upload-input-container-${parentId}`);
                linkInputContainer.style.display = fileSource === "link" ? "block" : "none";
                uploadInputContainer.style.display = fileSource === "upload" ? "block" : "none";
              }
        Â  Â  Â  async function submitInlineForm(parentId, buttonElement) { /* ... (no changes) ... */
                const name = document.getElementById(`name-${parentId}`).value.trim();
                const type = document.getElementById(`type-${parentId}`).value;
                const description = document.getElementById(`description-${parentId}`).value.trim();
                const originalButtonText = buttonElement.querySelector(".button-text")?.textContent || buttonElement.textContent;
                window.setButtonLoading(buttonElement, true, originalButtonText);
                if (!name) { window.showNotification("Name is required.", "error"); window.setButtonLoading(buttonElement, false, originalButtonText); return; }
                try {
                    let response;
                    if (type === "FILE") {
                        const fileSource = document.getElementById(`file-source-${parentId}`).value;
                        if (fileSource === "link") {
                            const link = document.getElementById(`link-${parentId}`).value.trim();
                            if (!link) { window.showNotification("Link is required.", "error"); window.setButtonLoading(buttonElement, false, originalButtonText); return; }
                            response = await secureFetch(`${BASE}/api/artifacts`, { method: "POST", body: JSON.stringify({ title: name, description, link, nodeId: parentId }) });
                        } else {
                            const fileInput = document.getElementById(`file-upload-${parentId}`); const file = fileInput.files[0];
                            if (!file) { window.showNotification("Please select a file.", "error"); window.setButtonLoading(buttonElement, false, originalButtonText); return; }
                            const formData = new FormData(); formData.append("file", file); formData.append("title", name); formData.append("description", description); formData.append("nodeId", parentId);
                            response = await secureFetch(`${BASE}/api/upload`, { method: "POST", body: formData });
                        }
                    } else { response = await secureFetch(`${BASE}/api/nodes`, { method: "POST", body: JSON.stringify({ name, type, parentId, description }) }); }
                    if (!response.ok) { const errorData = await response.json().catch(() => ({ message: response.statusText })); throw new Error(`Failed: ${errorData.message || response.statusText}`);}
                    window.showNotification("Item added! âœ…", "success"); fetchTree();
                    document.getElementById(`form-${parentId}`).style.display = "none"; /* Reset form */
                } catch (error) { console.error("Error submitting inline form:", error); window.showNotification(`Error: ${error.message}`, "error"); }
                finally { window.setButtonLoading(buttonElement, false, originalButtonText); }
              }
        Â  Â  Â  // --- Delete Confirmation Modal Logic (existing code) ---
        Â  Â  Â  const deleteConfirmationModal = document.getElementById("delete-confirmation-modal");
              const deleteModalTitle = document.getElementById("delete-modal-title");
              const deleteModalMessage = document.getElementById("delete-modal-message");
              const deleteConfirmInput = document.getElementById("delete-confirm-input");
              const confirmDeleteButton = document.getElementById("confirm-delete-button");
              let itemToDelete = { id: null, type: null, name: "" };
              function openDeleteConfirmationModal(itemId, itemType, itemName) { /* ... (no changes) ... */
                itemToDelete = { id: itemId, type: itemType, name: itemName };
                deleteModalTitle.textContent = `Confirm Deletion: ${escapeJSString(itemName)}`;
                deleteModalMessage.textContent = `Are you sure you want to delete the ${itemType} "${escapeJSString(itemName)}"? This action cannot be undone.`;
                if (itemType === 'node') deleteModalMessage.textContent += " All its contents will also be deleted.";
                deleteConfirmInput.value = ""; confirmDeleteButton.disabled = true; deleteConfirmationModal.classList.add("active"); deleteConfirmInput.focus();
              }
              function closeDeleteConfirmationModal() { deleteConfirmationModal.classList.remove("active"); }
              deleteConfirmInput.addEventListener("input", () => { confirmDeleteButton.disabled = deleteConfirmInput.value.trim().toLowerCase() !== "delete"; });
              confirmDeleteButton.addEventListener("click", async () => { /* ... (no changes) ... */
                if (deleteConfirmInput.value.trim().toLowerCase() !== "delete" || !itemToDelete.id) { window.showNotification("Deletion not confirmed.", "error"); return; }
                const originalButtonText = confirmDeleteButton.querySelector(".button-text")?.textContent || confirmDeleteButton.textContent;
                window.setButtonLoading(confirmDeleteButton, true, originalButtonText);
                try {
                    let endpoint = itemToDelete.type === "node" ? `${BASE}/api/nodes/${itemToDelete.id}` : `${BASE}/api/artifacts/${itemToDelete.id}`;
                    const response = await secureFetch(endpoint, { method: "DELETE" });
                    if (!response.ok) { const err = await response.json().catch(() => ({message: response.statusText})); throw new Error(`Failed: ${err.message || response.statusText}`);}
                    window.showNotification(`${itemToDelete.type.charAt(0).toUpperCase() + itemToDelete.type.slice(1)} "${escapeJSString(itemToDelete.name)}" deleted. âœ…`, "success");
                    fetchTree(); closeDeleteConfirmationModal();
                } catch (error) { console.error(`Error deleting ${itemToDelete.type}:`, error); window.showNotification(`Error: ${error.message}`, "error");}
                finally { window.setButtonLoading(confirmDeleteButton, false, originalButtonText); }
              });
        Â  Â  Â  async function promptNewRoot() { /* ... (no changes) ... */
                const name = prompt("Enter new root folder name (e.g., Vertical name):");
                if (!name?.trim()) return;
                try {
                    const response = await secureFetch(`${BASE}/api/nodes`, { method: "POST", body: JSON.stringify({ name: name.trim(), type: "VERTICAL", parentId: null, description: "Root Vertical Folder" }) });
                    if (!response.ok) { const err = await response.json().catch(()=>({message: response.statusText})); throw new Error(`Failed: ${err.message || response.statusText}`);}
                    window.showNotification("New root folder created! âœ…", "success"); fetchTree();
                } catch (error) { console.error("Error creating new root:", error); window.showNotification(`Error: ${error.message}`, "error"); }
              }
        
        
        Â  Â  Â  // MODIFIED ADD USER FORM SUBMIT HANDLER
        Â  Â  Â  document.getElementById("addUserForm").addEventListener("submit", async (e) => {
        Â  Â  Â  Â  e.preventDefault();
        Â  Â  Â  Â  const submitButton = e.target.querySelector('button[type="submit"]');
        Â  Â  Â  Â  const originalButtonText = submitButton.querySelector(".button-text")?.textContent || submitButton.textContent;
        Â  Â  Â  Â  window.setButtonLoading(submitButton, true, originalButtonText);
        
        Â  Â  Â  Â  const email = document.getElementById("newUserEmail").value.trim();
        Â  Â  Â  Â  const globalRole = document.getElementById("newUserRole").value;
        Â  Â  Â  Â  const selectedNodeIdForAccess = document.getElementById("newUserNodeAccess").value;
        Â  Â  Â  Â  const selectedNodeRoleForAccess = document.getElementById("newUserNodeRole").value;
                const applyGlobalToAllNodes = document.getElementById("applyGlobalRoleToAllNodesCheckbox").checked;
        
        Â  Â  Â  Â  if (!email || !globalRole) {
        Â  Â  Â  Â  Â  window.showNotification("Email and Global Role are required.", "error");
        Â  Â  Â  Â  Â  window.setButtonLoading(submitButton, false, originalButtonText);
        Â  Â  Â  Â  Â  return;
        Â  Â  Â  Â  }
        
        Â  Â  Â  Â  try {
        Â  Â  Â  Â  Â  // 1. Create the user with the global role
        Â  Â  Â  Â  Â  let userCreationResponse = await secureFetch(`${BASE}/api/users`, {
        Â  Â  Â  Â  Â  Â  method: "POST",
        Â  Â  Â  Â  Â  Â  body: JSON.stringify({ email, role: globalRole }),
        Â  Â  Â  Â  Â  });
        
        Â  Â  Â  Â  Â  if (!userCreationResponse.ok) {
        Â  Â  Â  Â  Â  Â  const errorData = await userCreationResponse.json().catch(() => ({ message: userCreationResponse.statusText }));
        Â  Â  Â  Â  Â  Â  throw new Error(`Failed to add user: ${errorData.message || userCreationResponse.statusText}`);
        Â  Â  Â  Â  Â  }
        
        Â  Â  Â  Â  Â  let overallSuccessMessage = "User added successfully! âœ…";
        
        Â  Â  Â  Â  Â  // 2. Handle node-specific access
        Â  Â  Â  Â  Â  if (selectedNodeIdForAccess) {
        Â  Â  Â  Â  Â  Â  // Grant access to a single selected node
        Â  Â  Â  Â  Â  Â  const accessResponse = await secureFetch(`${BASE}/api/access`, {
        Â  Â  Â  Â  Â  Â  Â  method: "PUT",
        Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
        Â  Â  Â  Â  Â  Â  Â  Â  email,
        Â  Â  Â  Â  Â  Â  Â  Â  nodeId: parseInt(selectedNodeIdForAccess),
        Â  Â  Â  Â  Â  Â  Â  Â  role: selectedNodeRoleForAccess,
        Â  Â  Â  Â  Â  Â  Â  }),
        Â  Â  Â  Â  Â  Â  });
        Â  Â  Â  Â  Â  Â  if (!accessResponse.ok) {
        Â  Â  Â  Â  Â  Â  Â  const errorData = await accessResponse.json().catch(() => ({ message: accessResponse.statusText }));
        Â  Â  Â  Â  Â  Â  Â  overallSuccessMessage += `\nâš ï¸ Could not grant initial node access: ${errorData.message || accessResponse.statusText}`;
        Â  Â  Â  Â  Â  Â  Â  window.showNotification(overallSuccessMessage, "error", 5000); // Show combined message as error
        Â  Â  Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  Â  Â  overallSuccessMessage += ` Initial node access granted.`;
                        window.showNotification(overallSuccessMessage, "success", 5000);
        Â  Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  } else if (applyGlobalToAllNodes) {
        Â  Â  Â  Â  Â  Â  // Grant selected global role to all nodes
                    window.showNotification(`User created. Now applying '${globalRole}' role to all nodes. This may take a moment...`, "info", 8000);
        
                    if (!flatNodeList || flatNodeList.length === 0) {
                        console.warn("flatNodeList is empty or not yet populated. Cannot apply global role to all nodes.");
                        overallSuccessMessage += "\nâš ï¸ No nodes found to apply global role to (tree data might be loading or empty).";
                        window.showNotification(overallSuccessMessage, "warn", 5000);
                    } else {
                        let nodesProcessedCount = 0;
                        let nodesFailedCount = 0;
                        // It's better to run these sequentially to avoid overwhelming the server or hitting rate limits
                        for (const item of flatNodeList) {
                            // Assuming item.id is the correct identifier for nodes/artifacts in /api/access
                            // And assuming globalRole is the role to be applied
                            try {
                                const nodeAccessResponse = await secureFetch(`${BASE}/api/access`, {
                                    method: "PUT",
                                    body: JSON.stringify({
                                        email,
                                        nodeId: parseInt(item.id),
                                        role: globalRole, // Use the selected global role
                                    }),
                                });
                                if (nodeAccessResponse.ok) {
                                    nodesProcessedCount++;
                                } else {
                                    nodesFailedCount++;
                                    const errorData = await nodeAccessResponse.json().catch(() => ({ message: nodeAccessResponse.statusText }));
                                    console.warn(`Failed to apply role to node ${item.id} ('${item.name}'): ${errorData.message || nodeAccessResponse.statusText}`);
                                }
                            } catch (loopError) {
                                nodesFailedCount++;
                                console.error(`Error applying role to node ${item.id} ('${item.name}'):`, loopError);
                            }
                        }
        
                        if (nodesFailedCount > 0) {
                            overallSuccessMessage += `\nâš ï¸ Applied '${globalRole}' to ${nodesProcessedCount} nodes, but failed for ${nodesFailedCount}. Check console.`;
                            window.showNotification(overallSuccessMessage, "error", 7000);
                        } else {
                            overallSuccessMessage += `\nSuccessfully applied '${globalRole}' role to all ${nodesProcessedCount} nodes.`;
                            window.showNotification(overallSuccessMessage, "success", 7000);
                        }
                    }
        Â  Â  Â  Â  Â  } else {
                    // Just user creation, no specific node access or apply-to-all
                    window.showNotification(overallSuccessMessage, "success");
                  }
        
        Â  Â  Â  Â  Â  fetchUsers(); // Refresh user list
        Â  Â  Â  Â  Â  document.getElementById("addUserForm").reset();
                  // Uncheck the checkbox manually if it's not part of form.reset()
                  const applyToAllCheckbox = document.getElementById("applyGlobalRoleToAllNodesCheckbox");
                  if (applyToAllCheckbox) applyToAllCheckbox.checked = false;
        
        Â  Â  Â  Â  } catch (error) {
        Â  Â  Â  Â  Â  console.error("Error in add user process:", error);
        Â  Â  Â  Â  Â  window.showNotification(`Error: ${error.message}`, "error", 5000);
        Â  Â  Â  Â  } finally {
        Â  Â  Â  Â  Â  window.setButtonLoading(submitButton, false, originalButtonText);
        Â  Â  Â  Â  }
        Â  Â  Â  });
        
        
        Â  Â  Â  // --- Access Management Modal Logic (existing code) ---
        Â  Â  Â  const accessModal = document.getElementById("access-management-modal");
              const modalUserEmailSpan = document.getElementById("modal-user-email");
              const modalCurrentAccessDiv = document.getElementById("access-management-modal-current-access");
              const modalEditingUserEmailHidden = document.getElementById("modal-editing-user-email-hidden");
              async function openAccessModal(email) { /* ... (no changes) ... */
                modalUserEmailSpan.textContent = email; modalEditingUserEmailHidden.value = email;
                accessModal.classList.add("active"); await loadUserAccessRolesForModal(email);
              }
              function closeAccessModal() { /* ... (no changes) ... */
                accessModal.classList.remove("active"); modalCurrentAccessDiv.innerHTML = `<p class="text-[var(--text-tertiary)] p-3">Loading access...</p>`;
              }
              async function loadUserAccessRolesForModal(email) { /* ... (no changes) ... */
                modalCurrentAccessDiv.innerHTML = `<div class="flex justify-center items-center p-4"><div class="spinner" style="border-color: var(--text-primary); border-top-color: transparent;"></div><span class="ml-2 text-[var(--text-secondary)]">Loading...</span></div>`;
                try {
                    const res = await secureFetch(`${BASE}/api/users`); if (!res.ok) throw new Error("Failed to fetch user data");
                    const users = await res.json(); const user = users.find(u => u.email === email);
                    if (!user || !user.roles || user.roles.length === 0) { modalCurrentAccessDiv.innerHTML = `<p class="text-[var(--text-tertiary)] p-3">No specific node access.</p>`; return; }
                    const items = await Promise.all(user.roles.map(async role => {
                        const nodeName = await fetchNodeName(role.nodeId);
                        return `<div class="access-item flex justify-between items-center p-2.5 border-b border-[var(--border-primary)] last:border-b-0"><div><span class="font-medium text-[var(--text-primary)]">${escapeJSString(nodeName)}</span></div><div class="flex items-center gap-2"><select class="input-field text-xs py-1 px-2 w-auto bg-[var(--bg-input)] border-[var(--border-input)]" data-node-id="${role.nodeId}" data-original-role="${role.role}" onchange="updateNodeAccessInModal(this, '${escapeJSString(email)}', ${role.nodeId})"><option value="ADMIN" ${role.role === "ADMIN" ? "selected" : ""}>ADMIN</option><option value="EDITOR" ${role.role === "EDITOR" ? "selected" : ""}>EDITOR</option><option value="VIEWER" ${role.role === "VIEWER" ? "selected" : ""}>VIEWER</option></select><button class="action-icon-btn delete text-sm" title="Revoke Access" onclick="revokeNodeAccessInModal('${escapeJSString(email)}', ${role.nodeId})"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div>`;
                    }));
                    modalCurrentAccessDiv.innerHTML = items.join("");
                } catch (error) { console.error("Error loading user access for modal:", error); modalCurrentAccessDiv.innerHTML = `<p class="text-[var(--text-red-accent)] p-3">Error: ${error.message}</p>`;}
              }
              async function updateNodeAccessInModal(selectElement, email, nodeId) { /* ... (no changes) ... */
                const newRole = selectElement.value; const originalRole = selectElement.dataset.originalRole; if (newRole === originalRole) return;
                try {
                    const response = await secureFetch(`${BASE}/api/access`, { method: "PUT", body: JSON.stringify({ email, nodeId, role: newRole }) });
                    if (!response.ok) { const err = await response.json().catch(()=>({message:response.statusText})); throw new Error(`Failed: ${err.message || response.statusText}`);}
                    window.showNotification("Access updated! âœ…", "success"); selectElement.dataset.originalRole = newRole; fetchUsers();
                } catch (error) { console.error("Error updating access:", error); window.showNotification(`Error: ${error.message}`, "error"); selectElement.value = originalRole;}
              }
              async function revokeNodeAccessInModal(email, nodeId) { /* ... (no changes) ... */
                if (!confirm(`Revoke access for ${email} from node ID ${nodeId}?`)) return;
                try {
                    const response = await secureFetch(`${BASE}/api/access`, { method: "DELETE", body: JSON.stringify({ email, nodeId }) });
                    if (!response.ok) { const err = await response.json().catch(()=>({message:response.statusText})); throw new Error(`Failed: ${err.message || response.statusText}`);}
                    window.showNotification("Access revoked! âœ…", "success"); loadUserAccessRolesForModal(email); fetchUsers();
                } catch (error) { console.error("Error revoking access:", error); window.showNotification(`Error: ${error.message}`, "error");}
              }
        Â  Â  Â  document.getElementById("grantNewAccessForm").addEventListener("submit", async (e) => { /* ... (no changes) ... */
                e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); const originalText = btn.querySelector('.button-text')?.textContent || btn.textContent;
                window.setButtonLoading(btn, true, originalText);
                const email = modalEditingUserEmailHidden.value; const nodeId = document.getElementById("modalNodeSelect").value; const role = document.getElementById("modalNodeRoleSelect").value;
                if (!email || !nodeId || !role) { window.showNotification("Select user, node, and role.", "error"); window.setButtonLoading(btn, false, originalText); return; }
                try {
                    const response = await secureFetch(`${BASE}/api/access`, { method: "PUT", body: JSON.stringify({ email, nodeId: parseInt(nodeId), role }) });
                    if (!response.ok) { const err = await response.json().catch(()=>({message:response.statusText})); throw new Error(`Failed: ${err.message || response.statusText}`);}
                    window.showNotification("Access granted! âœ…", "success"); loadUserAccessRolesForModal(email); fetchUsers();
                    e.target.reset(); document.getElementById("modalNodeSelect").value = "";
                } catch (error) { console.error("Error granting new access:", error); window.showNotification(`Error: ${error.message}`, "error");}
                finally { window.setButtonLoading(btn, false, originalText); }
              });
        
        Â  Â  Â  // --- Artifact Details Modal Logic (existing code) ---
        Â  Â  Â  const artifactDetailsModalEl = document.getElementById("artifact-details-modal");
              function showArtifactDetailsModal(title, description, link) { /* ... (no changes) ... */
                const titleEl = document.getElementById("artifact-modal-title"); const descEl = document.getElementById("artifact-details-modal-description"); const linkEl = document.getElementById("artifact-modal-link");
                if (!artifactDetailsModalEl || !titleEl || !descEl || !linkEl) { console.error("Artifact modal elements not found."); return; }
                titleEl.textContent = title || "Artifact Details"; descEl.innerHTML = description ? description.replace(/\n/g, "<br>") : "No description.";
                let pLink = link || "#"; if (pLink && !pLink.startsWith("http") && pLink !== "#") pLink = `https://${pLink}`; linkEl.href = pLink;
                if (!link || link === "#") { linkEl.classList.add("opacity-50", "cursor-not-allowed"); linkEl.removeAttribute("target"); linkEl.onclick = (ev) => ev.preventDefault(); }
                else { linkEl.classList.remove("opacity-50", "cursor-not-allowed"); linkEl.setAttribute("target", "_blank"); linkEl.onclick = null; }
                artifactDetailsModalEl.classList.add("active");
              }
              function closeArtifactDetailsModal() { if (artifactDetailsModalEl) artifactDetailsModalEl.classList.remove("active"); }
        
        Â  Â  Â  // --- User Menu Dropdown Logic (existing code) ---
        Â  Â  Â  if (userMenuButton && userDropdownMenu) { /* ... (no changes) ... */
                userMenuButton.addEventListener("click", () => {
                    const isExpanded = userMenuButton.getAttribute("aria-expanded") === "true" || false;
                    userMenuButton.setAttribute("aria-expanded", !isExpanded); userDropdownMenu.classList.toggle("hidden");
                });
                document.addEventListener("click", (event) => {
                    if (!userMenuButton.contains(event.target) && !userDropdownMenu.contains(event.target)) {
                        userDropdownMenu.classList.add("hidden"); userMenuButton.setAttribute("aria-expanded", "false");
                    }
                });
              }
        Â  Â  Â  if (logoutButtonDropdown) { /* ... (no changes) ... */
                logoutButtonDropdown.addEventListener("click", async () => {
                    if (firebaseAuth) { try { await firebaseAuth.signOut(); sessionStorage.removeItem("token"); window.showNotification("Logged out.", "success");}
                    catch (error) { console.error("Error signing out:", error); window.showNotification("Logout failed.", "error");}}
                });
              }
        
        Â  Â  Â  function initializeAdminPanel() {
        Â  Â  Â  Â  console.log("Initializing Admin Panel data...");
        Â  Â  Â  Â  if (firebaseAuth && firebaseAuth.currentUser) {
        Â  Â  Â  Â  Â  fetchTree(); // Populates fullTreeData and flatNodeList
        Â  Â  Â  Â  Â  fetchUsers();
        Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  console.log("User not logged in, skipping data fetch.");
                  if(userListElement) userListElement.innerHTML = `<p class="text-[var(--text-tertiary)] p-3 text-center">Please log in to view users.</p>`;
        Â  Â  Â  Â  Â  if(userListLoadingIndicator) userListLoadingIndicator.style.display = "none";
        Â  Â  Â  Â  }
        Â  Â  Â  }
        
        Â  Â  Â  document.addEventListener("keydown", (event) => { /* ... (no changes) ... */
                if (event.key === "Escape") {
                    if (accessModal.classList.contains("active")) closeAccessModal();
                    if (artifactDetailsModalEl?.classList.contains("active")) closeArtifactDetailsModal();
                    if (deleteConfirmationModal.classList.contains("active")) closeDeleteConfirmationModal();
                }
              });

      
    </script>
  </body>
</html>
