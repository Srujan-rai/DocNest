<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Login - My App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ... (keep styles the same) ... */
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="logo"></div>
      <h1>Login</h1>
      <p>Use your Google account to continue</p>

      <button id="googleSignInBtn">
        <img
          src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
          alt="Google icon"
        />
        Sign in with Google
      </button>

      <p id="message"></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ",
        authDomain: "docnest-f85e2.firebaseapp.com",
        projectId: "docnest-f85e2",
        storageBucket: "docnest-f85e2.appspot.com",
        messagingSenderId: "102395439437",
        appId: "1:102395439437:web:84e6676388b5d54395af04",
        measurementId: "G-YRMBR8BVSE",
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const googleSignInBtn = document.getElementById("googleSignInBtn");
      const messageElement = document.getElementById("message");
      const LANDING_PAGE_URL = "home.html"; // Make sure this filename matches exactly

      // --- MODIFIED: Check for existing session immediately ---
      let isRedirecting = false; // Flag to prevent double redirects
      auth.onAuthStateChanged((user) => {
        if (user && !isRedirecting) {
          console.log(
            "Login Page: User session found, redirecting to",
            LANDING_PAGE_URL
          );
          isRedirecting = true; // Set flag
          window.location.href = LANDING_PAGE_URL;
        } else if (!user) {
          console.log(
            "Login Page: No active user session detected by listener."
          );
          // Optional: Ensure login button is enabled if it might start disabled
          googleSignInBtn.disabled = false;
        }
      });

      // âœ… Set persistence & sign in
      googleSignInBtn.addEventListener("click", () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        googleSignInBtn.disabled = true;
        setMessage("Signing in...", "success");

        auth
          .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
          .then(() => auth.signInWithPopup(provider))
          .then((result) => {
            // Successful sign-in, redirection will be handled by onAuthStateChanged
            console.log(
              "Login Page: Sign-in successful for",
              result.user.displayName
            );
            // No need to redirect here, the listener will catch the change
            // window.location.href = LANDING_PAGE_URL; // REMOVED this line
          })
          .catch((error) => {
            googleSignInBtn.disabled = false;
            setMessage(`Login failed: ${error.message}`, "error");
            console.error("Login Error:", error);
          });
      });

      function setMessage(msg, type = "info") {
        // Default to info
        messageElement.textContent = msg;
        // Clear classes first
        messageElement.className = "";
        // Add specific class if error or success
        if (type === "error") {
          messageElement.classList.add("error");
        } else if (type === "success") {
          messageElement.classList.add("success");
        }
        // else it's just plain text
      }
    </script>
  </body>
</html>
